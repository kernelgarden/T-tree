<script>
var translateArr=new Array(2);	//translate 정보를 저장한 배열
var parentWidth;				//중심 원 가로 길이
var parentHeight;				//중심 원 세로 길이
var noOfServ;
var noOfServices;
var checkBefore;				//이전에 선택된 branch의 클래스 번호를 저장 
var checkThis;					//현재 선택된 branch의 클래스 번호를 저장
var checkFirst=true;			//루트인지를 저장 
var checkSecond=false;			//두번째인지를 저장 
var movingChild=false;		
var parentClickCnt=0;			//parent 가지 click 카운트 
var childBranchArr=new Array(8)	//child 가지 저장 배열 

function renderCircle(){
  	function toDegrees(angle){
    	return angle * (Math.PI / 180);
  	}//toDegrees()
  	var width = window.innerWidth||document.body.clientWidth;
  	var height =window.innerHeight||document.body.clientHeigh;
  	if(height<500){
	    width=1366;
	    height=768;
  	}//if

  	//parent 위치 설정 
  	var parent = $('div.parent');
  	parentWidth=width*(1/9);
  	parentHeight=parentWidth;
  	parent.width(String(parentWidth));
  	parent.height(String(parentHeight));
  	var parentCircleHalfWidth = (parent.width()/2);
  	var parentTop = parent.offset({top:((height)+40)/2 - parentCircleHalfWidth});
  	var parentLeft = parent.offset({left:(width)/2 - parentCircleHalfWidth});

  	//childGroup 설정 
  	var childGroup = $('div.childGroup');
  	childGroup.width(String(parentWidth));
  	childGroup.height(String(parentHeight));
  	childGroup.offset({top:((height)+40)/2 - parentCircleHalfWidth});
  	childGroup.offset({left:(width)/2 - parentCircleHalfWidth});

  	//Number of services
  	noOfServices = 8;
  	noOfServ=noOfServices;
  	translateArr[0]=new Array(noOfServices);
  	translateArr[1]=new Array(noOfServices);
  	//Add some padding from parent circle
  	var Hyp = parentCircleHalfWidth*2;
  	//360 degrees / the number of services
  	var angle = Math.round(360 / noOfServices);
  	for(var i = 1; i <= noOfServices; i++){
	    var currentAngle = i * angle;
	    //calculate the positioning of the child circle around the parent circle
	    var circlePosXOpp = (Math.sin(toDegrees(currentAngle)) * Hyp);
	    var circlePosYAdj = (Math.cos(toDegrees(currentAngle)) * Hyp);
	  	translateArr[0][i-1]=circlePosXOpp;
	    translateArr[1][i-1]=circlePosYAdj;
	    //create a child element and assign "child" class with some properties such as positining
	    var currentChild = $('<div class="child"></div>').appendTo('div.childGroup');
	    currentChild.addClass('child'+i);
	    currentChild.width(String(width*(1/18)));
	    currentChild.height(String(width*(1/18)));
	    var childCircleHalfWidth=(currentChild.width()/2);
	    currentChild.css({'top':(+childCircleHalfWidth)+'px'});
	    currentChild.css({'left':(+childCircleHalfWidth)+'px'});
      //currentChild.css({'-webkit-transform': 'translate('+circlePosXOpp + 'px, ' + -circlePosYAdj + 'px)'});
	    currentChild.css({'transform' : 'translate('+circlePosXOpp + 'px, ' + -circlePosYAdj + 'px)'});
  	}//for
  	
  	///////////////////////////// back버튼 //////////////////////////////////
  	var backButton = $('<div class="back"></div>').appendTo('div.childGroup');
  	backButton.width(String(width*(1/18)));
	backButton.height(String(width*(1/18)));
	backButton.css({'top':(+(backButton.width()/2))+'px'});
	backButton.css({'left':(+(backButton.width()/2))+'px'});
	var backPosXOpp = (Math.sin(toDegrees(8 * angle)) * Hyp);
	var backPosYAdj = (Math.cos(toDegrees(8 * angle)) * Hyp)*1.5;
	backButton.css({'transform' : 'translate('+backPosXOpp + 'px, ' + -backPosYAdj + 'px)'});
	$('.back').fadeOut(0);
	////////////////////////////////////////////////////////////////////////

  	//리스트 
    $(function() {
      var width = window.innerWidth||document.body.clientWidth;
      var height =window.innerHeight||document.body.clientHeigh;
      $('.child4,.child5,.child6,.child7').hover(function(){
        $('.list').fadeIn(800)
        .width(String(width*(1/8)))
        .height(String(width*(1/6)))
        .css('top', +height*(1/2)-width*(1/12))
        .css('left', +width*(1/8))
        $('.list li').transition({
          rotateX: '360',
          duration:1000
        })
      }, function() {
        $('.list').stop(true).fadeOut(300);
      })
      $('.child1,.child2,.child3,.child8').hover(function(){
        $('.list').fadeIn(800)
        .width(String(width*(1/8)))
        .height(String(width*(1/6)))
        .css('top', +height*(1/2)-width*(1/12))
        .css('left', width-2*(width*(1/8)))
        $('.list li').transition({
          rotateX: '360',
          duration:1000
        })
      }, function() {
        $('.list').stop(true).fadeOut(300);
      })
    })//리스트 function

    /////////////////////////////Json/////////////////////////////
    if(checkFirst==true){
    	$(".parent").empty(); 
    	$(".child").empty(); 
	    $.getJSON("/api/work/1", function(response) {
			$(".parent").empty().append(response.id);
			$(".parent").append(response.name);
		});
	  	$.getJSON("/api/work/1/branche_ids", function(response) {
			$.each(response, function (i,first) {
				//$(".child"+(i+1)).append(first);
				var temp=(i+1) 
				$.getJSON("/api/branch/"+temp, function(response) {
					if(response.parent_id==null){
						$(".child"+temp).empty().append(response.id);
						$(".child"+temp).append(response.name);
					}
				});
			});
		});

  	}
  	//////////////////////////////////////////////////////////////

  	/////////////////////////////Json/////////////////////////////
  	//window resize할 때 필요 
  	if(checkFirst!=true){
		$.getJSON("/api/branch/"+checkThis, function(response) {
			$(".parent").empty().append(response.id);
			$(".parent").append(response.name);
		});
		$.getJSON("/api/branch/"+checkThis, function(response) {
			$.each(response.child_ids, function (i,first) {
				//$(".child"+(i+1)).append(first);
				var temp=first
					
				$.getJSON("/api/branch/"+temp, function(response) {
					var index=(temp%7)
					if(index==0) index=7;
					$(".child"+index).empty().append(response.id);
					$(".child"+index).append(response.name);
				});
			});
		});
	}
  	////////////////////////////////////////////////////////////

    //branch 누르면
    $('.child').click(function(){
    	$('.back').fadeOut();
    	///////////////////// json 초기화 //////////////////////
    	$(".parent").empty(); 
    	$(".child").empty(); 
    	///////////////////////////////////////////////////////
    	
    	//$('.parent').removeClass("zoomTarget selectedZoomTarget zoomNotClickable")
    	movingChild=true;
    	$('.child').fadeIn(0)
    	//$('.child').unbind("mouseenter");
    	$('.parent').css("z-index", 5)
    	$(this).css("z-index", 2)
    	//선택된 가지를 제외 하고 사라짐
 		//$('.child').not(this).fadeOut('slow')
 		// parent 가지의 색깔을 투명하게
 		$( '.parent, .child' ).not(this).animate({
          backgroundColor: "transparent",
        }, 700 )
        $('.child').not(this).transition({ x:0+'px', y:0+'px', scale: 1, duration:0});
        // 선택된 가지를 중심으로 이동
        $(this).delay(200).transition({ x:0+'px',y:0+'px',duration: 400});
        // 선택된 가지를 parent가지의 크기만큼 확대
       	$(this).transition({ x:-(parentWidth/4)+'px', y:-(parentWidth/4)+'px', scale: 2.0 ,duration: 400});
       	// parent 가지의 색깔을 child 가지의 색깔로 변화시킴
       	
       	$( '.parent' ).delay(400).animate({
          backgroundColor: "#53c3d3",
        }, 'slow' )
        // 선택했던 child가지를 사라지게 함
        //$(this).delay(300).fadeOut('fast')
        // parent가지의 색깔을 원래 색깔로 되돌려줌
        /*$( '.parent' ).animate({
          backgroundColor: "#53c3d3",
        }, 3000 )*/
        //$(this).transition({ x:0+'px', y:0+'px', scale: 1, duration:0})
        //$('.child').fadeIn('slow')
        
        var checkBranch;

        for(var i = 1; i <= noOfServ; i++){
        	if($(this).hasClass('child'+i)){
        		checkThis=i;
        	}
        }
        for(var i = 0; i < noOfServ; i++){
        	if($('.child').eq(i).hasClass('child8')){
        		if(checkThis==8){
        			$('.child').eq(i).css("z-index", 3)
		        	$('.child').eq(i).delay(0).animate({
				    	backgroundColor: "#53c3d3",
				    } )
				    $('.child').eq(i).removeClass('child'+checkThis)
        		}else{
	        		$('.child').eq(i).css("z-index", 2)
	        		$('.child').eq(i).delay(300).animate({
			          backgroundColor: "#ECA812",
			        } )
	        		$('.child').eq(i).delay(30).transition({ x:translateArr[0][checkThis-1]+'px', y:-translateArr[1][checkThis-1]+'px'});
	        		$('.child').eq(i).addClass('child'+checkThis)
	        		$('.child').eq(i).removeClass('child8')
	        	}
        	}//if
        	else if(!($('.child').eq(i).hasClass('child'+checkThis))){
        		$('.child').eq(i).css("z-index", 2)
        		for(var j = 1; j <= noOfServ; j++){
		        	if($('.child').eq(i).hasClass('child'+j)){
		        		checkBranch=j;
		        	}
		        }
        		$('.child').eq(i).delay(300).animate({
			         backgroundColor: "#ECA812",
				} )
	        	$('.child').eq(i).delay(30).transition({ x:translateArr[0][checkBranch-1]+'px', y:-translateArr[1][checkBranch-1]+'px'});
        	}
        	else{
        		$('.child').eq(i).css("z-index", 3)
	        	$('.child').eq(i).delay(0).animate({
			    	backgroundColor: "#53c3d3",
			    } )
			    $('.child').eq(i).removeClass('child'+checkThis)
        	}//else
        }//for
        for(var i = 1; i <= noOfServ; i++){
        	if($(this).hasClass('child8')){
        		checkFirst=true;
        	}else{
        		checkFirst=false;
        	}
        }

        if(checkFirst==false) {
        	if(checkSecond==true) checkSecond=3;	//이미 두번째를 지났으면 false 표시 
        	else if(checkSecond==false) checkSecond=true;	//두번째임을 표시 
        	$(this).addClass('child8');
        	if(checkSecond==true) $('.back').delay(1550).fadeIn(300); //두번째일때 속도 조절
        	else $('.back').delay(1200).fadeIn(300); 
        }
        movingChild=false;

    ////////////////////////////////Json///////////////////////////////
		setTimeout(function(){
		 	$.getJSON("/api/branch/"+checkThis, function(response) {
				$(".parent").empty().append(response.id);
				$(".parent").append(response.name);
			});
			$.getJSON("/api/branch/"+checkThis, function(response) {
				$.each(response.child_ids, function (i,first) {
					//$(".child"+(i+1)).append(first);
					var temp=first
					
					$.getJSON("/api/branch/"+temp, function(response) {
						var index=(temp%7)
						if(index==0) index=7;
						$(".child"+index).empty().append(response.id);
						$(".child"+index).append(response.name);
					});
				});
			});
		}, 1400);  

  	///////////////////////////////////////////////////////////////////
  	///
    })//child-click
	
	//back button 누르면
    $('.back').click(function(){
    	$(this).fadeOut(0)
    	$('.parent').empty();
    	$('.child').empty();
    	//child가지 중심으로 이동 
    	$('.child').delay(200).transition({ x:0+'px',y:0+'px',duration: 400, scale: 1.0});
    	$('.child8').fadeIn(0).transition({ x:-(parentWidth/4)+'px', y:-(parentWidth/4)+'px', scale: 2.0 ,duration: 30});
    		$('.child8').delay(0).animate({
			    backgroundColor: "#ECA812",
			}, 0 )
			$('.child8').delay(130).transition({ x:0+'px',y:0+'px',duration: 500, scale: 1.0}).delay(60).transition({ x:translateArr[0][checkThis-1]+'px', y:-translateArr[1][checkThis-1]+'px'});
			//느려서 좀 뒤로 넣음 
    		$( '.parent, .child' ).delay(600).not('.child8').animate({
	          backgroundColor: "transparent",
	        }, 200)
	        $( '.parent').delay(600).animate({
	          backgroundColor: "#53c3d3",
	        }, 300)
	        
			$( '.child').not('.child8').delay(500).animate({
	          backgroundColor: "#ECA812",
	        }, 50)

	        //child8과 이전 가지의 교환 
	        $('.child'+checkThis).addClass('child9')
	        $('.child9').removeClass('child'+checkThis);
	        $('.child8').addClass('child'+checkThis);
	        $('.child'+checkThis).removeClass('child8')
	        $('.child9').addClass('child8')
	        $('.child8').removeClass('child9')

    	//두번째 childbranch이면 
    	if(checkSecond==true){
    		
    		checkSecond=false;
    		

	        for(var i = 1; i <=noOfServ; i++){
	        	$('.child'+i).transition({ x:translateArr[0][i-1]+'px', y:-translateArr[1][i-1]+'px'});
	        }//for

	        //루트로 변경 
    		checkFirst=true;

	        /////////////////////////////Json/////////////////////////////
	        setTimeout(function(){
			    if(checkFirst==true){
			    	$(".parent").empty(); 
			    	$(".child").empty(); 
				    $.getJSON("/api/work/1", function(response) {
						$(".parent").empty().append(response.id);
						$(".parent").append(response.name);
					});
				  	$.getJSON("/api/work/1/branche_ids", function(response) {
						$.each(response, function (i,first) {
							//$(".child"+(i+1)).append(first);
							var temp=(i+1) 
							$.getJSON("/api/branch/"+temp, function(response) {
								if(response.parent_id==null){
									$(".child"+temp).empty().append(response.id);
									$(".child"+temp).append(response.name);
								}
							});
						});
					});
			  	}
			  }, 1900); 
		  	//////////////////////////////////////////////////////////////

    	}
    	else{
    		
	        $('.child8').fadeOut(0)

	        for(var i = 1; i <=noOfServ; i++){
	        	$('.child'+i).transition({ x:translateArr[0][i-1]+'px', y:-translateArr[1][i-1]+'px'});
	        }//for

	        
	        /////////////////////////////Json/////////////////////////////
	        
	        setTimeout(function(){
	        	$.getJSON("/api/branch/"+checkThis, function(response) {
					checkBefore=response.parent_id;
				    $.getJSON("/api/branch/"+checkBefore, function(response) {
						$(".parent").empty().append(response.id);
						$(".parent").append(response.name);
					});
					$.getJSON("/api/branch/"+checkBefore, function(response) {
						$.each(response.child_ids, function (i,first) {
							//$(".child"+(i+1)).append(first);
							var temp=first
							
							$.getJSON("/api/branch/"+temp, function(response) {
								var index=(temp%7)
								if(index==0) index=7;
								$(".child"+index).empty().append(response.id);
								$(".child"+index).append(response.name);
							});
						});
					});
					checkThis=checkBefore;
					$.getJSON("/api/branch/"+checkBefore, function(response) {
						checkBefore=response.parent_id;
						if(checkBefore==null){
							checkSecond=true
						}
					});
				});
			  }, 1900); 
		  	//////////////////////////////////////////////////////////////
			$(this).delay(2100).fadeIn()
    	}
    	//$('.child').eq(i).delay(30).transition({ x:translateArr[0][checkThis-1]
    });

}//renderCircle()

  $(document).ready(function(){
  	checkDocument=true;
    var width = window.innerWidth||document.body.clientWidth;
    var height =window.innerHeight||document.body.clientHeigh;
    if(height<500){
      width=1366;
      height=768;
    }
    renderCircle();
    
    $(document).on("mouseenter", ".child", function(){
    	if(movingChild==false){
    		$(this).width(String(width*(1/13)));
		    $(this).height(String(width*(1/13)));
		    $(this).css({'top':(+(width*(1/52)))+'px'});
		    $(this).css({'left':(+(width*(1/52)))+'px'});
    	}
    })
    $(document).on("mouseleave", ".child", function(){
    	if(movingChild==false){
    		$(this).width(String(width*(1/18)));
		    $(this).height(String(width*(1/18)));
		    $(this).css({'top':((width*(1/36)))+'px'});
		    $(this).css({'left':((width*(1/36)))+'px'});
    	}
    })
    $(document).on("click",".child",function() {
    	$('.parent').empty();
    	$('.child').empty();

        if(checkFirst==false){
        	$('.child8').fadeOut();
        }
        //$(this).zoomTo({targetsize:0.75, duration:600});
    	//e.stopPropagation();
        
    });
    
    //루트가 아닐 때
    $(document).on("click", function(){

    	if(checkFirst==false){
	    //parent 가지를 눌렀을 때 확대 조정 
	    $(document).on("click",".parent",function() {
	    	//1번 눌렀을 때 조금 확대(0.85배)
	    	if(parentClickCnt==0){
	    		parentClickCnt++;
	    		$(this).zoomTo({targetsize:0.8, duration:900});
	    		$(this).empty().append("ㅎㅎ");
	    		//$('body').animate({ 'zoom': 2 }, 400);
	    	}
	    	//2번 눌렀을 때 완전 확대(3배)
	    	else if(parentClickCnt==1){
	    		parentClickCnt++;
	    		$(this).zoomTo({targetsize:3, duration:900});
	    		//$('body').animate({ 'zoom': 3 }, 900);
	    	}
	    	//그 이상으로 눌렀을 때 다시 축소 
	    	else {
	    		parentClickCnt=0;
	    		$('body').zoomTo({targetsize:1, duration:600});
	    		//$('body').animate({ 'zoom': 1 }, 600);
	    	}
	    	e.stopPropagation();
	    });
	    //바탕을 누르면 다시 축소 
	    $(document).click(function() {
	    	//확대 수 초기화 
	    	parentClickCnt=0;
		  	$('body').zoomTo({targetsize:1, duration:600});
		  	//$('body').animate({ 'zoom': 1 }, 600);
	  	});
	}
	});
  })//document.ready
  
  $(window).resize(function(){
  	checkDocument=false
    $('.parent').empty();
    $('.childGroup').empty();
    var width = window.innerWidth||document.body.clientWidth;
    var height =window.innerHeight||document.body.clientHeigh;
    if(height<500){
      width=1366;
      height=768;
    }

    renderCircle();

    if(checkFirst==false){
    	
    }

    $(document).on("mouseenter", ".child", function(){
    	if(movingChild==false){
    		$(this).width(String(width*(1/13)));
		    $(this).height(String(width*(1/13)));
		    $(this).css({'top':(+(width*(1/52)))+'px'});
		    $(this).css({'left':(+(width*(1/52)))+'px'});
    	}
    })
    $(document).on("mouseleave", ".child", function(){
    	if(movingChild==false){
    		$(this).width(String(width*(1/18)));
		    $(this).height(String(width*(1/18)));
		    $(this).css({'top':((width*(1/36)))+'px'});
		    $(this).css({'left':((width*(1/36)))+'px'});
    	}
    })
    $(document).on("click",".child",function() {
        if(checkFirst==false) $('.child8').fadeOut(0);

        //$(this).zoomTo({targetsize:0.75, duration:600});
    	//e.stopPropagation();
        
    });
    
    //parent 가지를 눌렀을 때 확대 조정 
    $(document).on("click",".parent",function() {
    	//1번 눌렀을 때 조금 확대(0.85배)
    	if(parentClickCnt==0){
    		parentClickCnt++;
    		$(this).zoomTo({targetsize:0.8, duration:900});
    	}
    	//2번 눌렀을 때 완전 확대(3배)
    	else if(parentClickCnt==1){
    		parentClickCnt++;
    		$(this).zoomTo({targetsize:3, duration:900});
    	}
    	//그 이상으로 눌렀을 때 다시 축소 
    	else {
    		parentClickCnt=0;
    		$('body').zoomTo({targetsize:1, duration:600});
    	}
    	e.stopPropagation();

    });
  })

  </script>

<div id="wrapDiv">
	<div id="parent" class="parent"></div>
	<div class="childGroup"> </div>
	<ul class="list" id="list">
		<li>One</li> 
		<li>Two</li>
		<li>Three</li>
		<li>Four</li>
		<li>Five</li>
		<li>Six</li>
		<li>Seven</li>
		<li>Eight</li>
	</ul>
</div>
