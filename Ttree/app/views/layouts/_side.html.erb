<%= javascript_tag do %>
  window.userID = "<%= current_user.id%>";
  window.userName ="<%= current_user.name %>";
  window.workLength ="<%= current_user.work_ids.length %>";
  window.createWork ='<%=  link_to "<div class='+'create_personal_work'+'></div>".html_safe%>';
  window.addWork ='<%=  link_to "<div class='+'personal_work_content'+'></div>".html_safe%>';
<% end %>

<div id='side_bar'>
	<div id='page_alert'>
		<div id='page_alert_num'>

    </div>
	</div>

</div>
<div id='unPageBox'>
</div>

<script>
function closeHover(element) {
  element.setAttribute('src', '/assets/closeMini2.png');
}
function closeUnhover(element) {
  element.setAttribute('src', '/assets/closeMini.png');
}
var width =window.screen.availWidth||window.innerWidth||document.body.clientWidth;
var height =window.screen.availHeight||document.body.clientHeigh;
var widthPosition =window.innerWidth||window.innerWidth||document.body.clientWidth;
var heightPosition =window.innerHeight||document.body.clientHeigh;
var pagesClickCnt=0;
var flag=100;
var pageWidth;
var pageHeight;
var beforeAlertNum=0;  //저장된 이전 페이지 수 

var setSize=function(){ //사이즈 세팅해주는 함수
  var width =window.screen.availWidth||window.innerWidth||document.body.clientWidth;
  var height =window.screen.availHeight||document.body.clientHeigh;
  var widthPosition =window.innerWidth||window.innerWidth||document.body.clientWidth;
  var heightPosition =window.innerHeight||document.body.clientHeigh;
  $('#side_bar').width(width*15/100)
  $('#side_bar').height(height*2/3)
  $('#side_bar').offset({right:width*10/100});
  $('#side_bar').offset({top:height*5/100-7});
  //사이드바 원 높이를 가로와 맞게
  $('#page_alert').height($('#page_alert').width())
  $('#page_alert_num').height($('#page_alert_num').width()*4/5)

  $('#page_alert').show();
}

$('#page_alert').draggable({
	revert: false,
	start: function(event, ui) {
		ui.helper.data('droppedAt', -1); // 원에 드랍시 0 > 의 상수 기타 <= 0
		ui.helper.data('draggablePos', $(this).position());
    $('#page_alert').transition({
      scale: 0.65,
      duration: 0
    });
	},
	stop: function(event, ui) {
      $('#page_alert').transition({
        scale: 1,
        duration: 0
      });
      //alert(ui.helper.data('droppedAt'));
			if (ui.helper.data('droppedAt') != -1)
				$(this).css({
					left: ui.helper.data('draggablePos').left,
					top: ui.helper.data('draggablePos').top
				});
      // Check value of ui.helper.data('dropped') and handle accordingly...
  }
});

var checkPageAlerNum=function(){  //branch에 포함되지 않은 페이지들의 개수를 체크해 할당
  var currentAlertNum;//현재 페이지들의 개수 
  var alertNumGap2;    //현재 페이지들의 개수와 이전 페이지들의 개수의 차이 
  $.getJSON("/api/user/"+userID, function(response) {
    currentAlertNum=response.unclassifiedpage_ids.length;
    $('#page_alert_num').empty().append(response.unclassifiedpage_ids.length)
    $.each(response.unclassifiedpage_ids, function (i,first) {

    });
  }, 1900).complete(function(){
    alertNumGap2=currentAlertNum-beforeAlertNum;
    beforeAlertNum=currentAlertNum;
    if(alertNumGap2!=0) showPageCntBox(1);
  });
}
var pagesInform=function(){
  var unPages = $('<div class="unPages"></div>').appendTo('#unPageBox');
  var unPage=$('<ol class="unPage"></ol>').appendTo('.unPages');
  var unPages = $('<div class="unPages"></div>').appendTo('#unPageBox');
        var unPage=$('<ol class="unPage"></ol>').appendTo('.unPages');
        $('.unPages').transition({ x:+(widthPosition*1.4/5)+'px',y:0+'px',duration: 0, scale: 1.0});
        $('.unPages').width(width*2.1/5)
        //$('.unPages').height(height*10/10)
        $('.unPages').css({top:height*1.5/10})
        $('.unPages').attr("data-id",0)
}

var showPageCntBox=function(status){  //페이지 추가할때마다 시간 순으로 나눔 
  
  var pluginClickCnt=0;   //플러그인을 클릭한 횟수 
  var beforeTime=0;       //이전 페이지의 created_at
  var samePageTimeCnt=1;  //생성시간이 같은 페이지 개수 
  var colorArray=["#b1e0f8", "#a8cfc3", "#eb9980", "#f1cdcf", "#f1e8b2"];
  setTimeout(function() {
    $.getJSON("/api/user/" + userID + "/unclassifiedpages", function(response) {
      $.each(response, function(i, page) {
        //이전페이지의 created_at과 다르면 플러그인 클릭 횟수 증가 
        if(page.timenum!=beforeTime){
          //생성시간이 같은 페이지 개수 초기화 
          samePageTimeCnt=1;
          if(pluginClickCnt==0) $('.unPages').empty().prepend('<div class="pageCntBox pageCntBox'+pluginClickCnt+'" id="pageCntBox"></div>')
          else $('.unPages').prepend('<div class="pageCntBox pageCntBox'+pluginClickCnt+'" id="pageCntBox"></div>')
          $('.pageCntBox').width($('.unPages').width()*10/10);
          $('.pageCntBox').height($('.unPages').width()*1.5/10);
          $('.pageCntBox'+pluginClickCnt).attr("data-time", page.timenum);
          $('.pageCntBox'+pluginClickCnt).attr("data-cnt", pluginClickCnt);
          $('.pageCntBox'+pluginClickCnt).attr("data-click", 0);
          $('.pageCntBox'+pluginClickCnt).empty().append('<span class="pageBoxTime">'+page.time+'</span><span class="pageNum">'+samePageTimeCnt+'</span><div class="pageBoxContent"></div>');
          $('.pageCntBox'+pluginClickCnt).css("background-color",colorArray[pluginClickCnt%5]);
          pluginClickCnt++;
          beforeTime=page.timenum;
        }else{
          samePageTimeCnt++;
          //페이지 개수 출력 
          $('.pageCntBox'+(pluginClickCnt-1)+' .pageNum').empty().append(samePageTimeCnt);
        }
      });//each 
    }, 0).complete(function() {
      $('.pageCntBox').draggable({
        //containment: "window",
        //cursor: "crosshair",
        appendTo: 'body',
        helper: 'clone',
        revert: false,
        start: function(event, ui) {
          ui.helper.data('droppedAt', -1); // 원에 드랍시 0 > 의 상수 기타 <= 0
          ui.helper.data('draggablePos', $(this).position());
          ui.helper.attr("data-type", "pageCntBox")
          ui.helper.transition({
            rotate: '-15deg',
            //scale: 0.7,
            duration: 0
          });
          ui.helper.addClass("clone");
          $('.clone .pageBoxContent').empty();
          ui.helper.height($('.unPages').width() * 1.5 / 10);

          //-------------------------드래그 하는 동안 사이드 바 숨기기 
          $('.unPages').css({
            right: -250
          })
          flag = 1;
          //alert(1)
          //console.log("hide")
          $('.unPages').transition({
            x: 1
          });
          //$('.unPages').hide();
          $('.unPages').attr("data-id", 0)
          $('#page_alert').show();
          //--------------------------------------------------------
        },
        stop: function(event, ui) {
          $('.pageCntBox').transition({
            scale: 1,
            duration: 0
          });
          //alert(ui.helper.data('droppedAt'));
          if (ui.helper.data('droppedAt') != -1)
            $(this).css({
              left: ui.helper.data('draggablePos').left,
              top: ui.helper.data('draggablePos').top
            });
          // Check value of ui.helper.data('dropped') and handle accordingly...
        },
      }); //draggable

    })//complete
  }); //setTimeout

  var clickCntArray = new Array(pluginClickCnt);
  if(status!=1){
    $(document).on("click", ".pageCntBox", function() {
      var thisCreatedAt = $(this).data("time"); //클릭한 박스의 생성 시간 
      var thisPluginClickCnt = $(this).data("cnt"); //클릭한 박스가 몇번째의 플러그인 클릭으로 생성되었는지 카운트 
      var thisBox = $('.pageCntBox' + thisPluginClickCnt);
      //클릭한 박스의 컨텐츠 
      //var thisPageTimeBox=$('.pageCntBox'+thisPluginClickCnt +' .pageBoxTime'); 
      var thisPageBox = $('.pageCntBox' + thisPluginClickCnt + ' .pageBoxContent');
      var plusHeight = $('.pageCntBox').width() * 6 / 10; //증가시켜야하는 높이 
      var pagecnt = 0; //해당 박스에 들어갈 페이지 개수 
      if (clickCntArray[thisPluginClickCnt - 1] == 0) {
        //alert(clickCntArray[thisPluginClickCnt-1])
        clickCntArray[thisPluginClickCnt - 1] = 1
        thisPageBox.empty();
        thisBox.height($('.unPages').width() * 1.5 / 10);
      } else {
        //alert(clickCntArray[thisPluginClickCnt-1])
        clickCntArray[thisPluginClickCnt - 1] = 0
        $.getJSON("/api/user/" + userID + "/unclassifiedpages", function(response) {
          thisPageBox.empty();

          $.each(response, function(i, page) {
            //클릭한 박스의 생성시간과 페이지들의 시간이 같으면 
            if (thisCreatedAt == page.timenum) {
              pagecnt++;
              thisPageBox.append('<div class="pageli-2 pageli_' + thisPluginClickCnt + '_' + i + '"></div>');
              $('.pageli-2').height($('.pageli-2').width());
              $('.pageli_' + thisPluginClickCnt + '_' + i).append('<img id="loadingImg" class="img' + i + '" src="/assets/loading3.svg" height="60%" width="60%" />');
              var img = $('<img class="img" src="http://ryugarden.org/api/thumb?url=' + page.url + '" />')
              img.load(function() {
                $('.img' + i).replaceWith(img);
                //$('.pageli_' + thisPluginClickCnt + '_' + i).append('<img id="closeImg' + i + '" class="closeImg" src="/assets/closeMini.png" onmouseover="closeHover(this);"" onmouseout="closeUnhover(this);" height="15px" width="15px"/>');
              });
              //$('#closeImg' + i).attr("data-id", page.id)
              $('.pageli_' + thisPluginClickCnt + '_' + i).append('<div class="page_url_div"><a class="page_url">' + page.title + '</a></div>');
              $('.pageli_' + thisPluginClickCnt + '_' + i).attr("data-url", page.url)
            }
          });
          thisBox.height($('.unPages').width() * 2 / 10 + ($('.pageli-2').height() * 1.15) * parseInt((pagecnt + 1) / 2));
          
          $('.pageli-2').draggable({
            //containment: "window",
            //cursor: "crosshair",
            cancel: false,
            appendTo: 'body',
            helper: 'clone',
            revert: false,
            start: function(event, ui) {
              ui.helper.data('droppedAt', -1); // 원에 드랍시 0 > 의 상수 기타 <= 0
              ui.helper.data('draggablePos', $(this).position());
              ui.helper.transition({
                rotate: '-15deg',
                duration: 0
              });
              ui.helper.addClass("clonePage");
              ui.helper.height($('.pageli-2').height());
              ui.helper.width($('.pageli-2').width());
              $('.clonePage .closeImg').remove();

              //-------------------------드래그 하는 동안 사이드 바 숨기기 
              
              $('.unPages').css({
                right: -250
              })
              flag = 1;
              //alert(1)
              //console.log("hide")
              $('.unPages').transition({
                x: 1
              });
              //$('.unPages').hide();
              $('.unPages').attr("data-id", 0)
              $('#page_alert').show();
              //--------------------------------------------------------

            },
            stop: function(event, ui) {

            }
          });//draggable

        })//json
      } //else
    }); //click
  } 
}
var showPages=function(){  //페이지 화면 띄워즈는 함수
  var flag=100;
  $(document).on("click", "#page_alert", function() {
    if ($('#unPageBox').empty()) {
      var unPages = $('<div class="unPages"></div>').appendTo('#unPageBox');

      //var openAllPageBtn = $('<input type="button" id="unpages_open_all_btn" value="Open All Pages" />').appendTo('.unPages');
      var unPage = $('<ol class="unPage"></ol>').appendTo('.unPages');
      //$('.unPages').transition({ x:+(widthPosition*2.5/5)+'px',y:0+'px',duration: 0, scale: 1.0});
      pageWidth=$('.unPages').width(250)
      pageHeight=$('.unPages').height(height * 9/ 10)
      
      //$('.unPages').hide();
      if (flag == 100) {
        $('.unPages').css({
          right:-(width * 0.6 / 5)
          //right: 5 + $('#side_bar').width()
        })
        $('.unPages').attr("data-id", 0)
        flag = $('.unPages').data("id");
        $('#page_alert').fadeOut(100);
      } else if (flag == 0) {
        $('.unPages').css({
          right:0
        })
        $('.unPages').attr("data-id", 1)
        flag = $('.unPages').data("id");
      } else if (flag == 1) {
        $('.unPages').css({
          right:-(width * 0.6 / 5)
        })
        $('.unPages').attr("data-id", 0)
        flag = $('.unPages').data("id");
        $('#page_alert').fadeOut(300);
      }
      //시간순으로 나눠주기 
      showPageCntBox();
    }
    if ($('.unPages').data("id") == 0) {
      //$('.unPages').show();
      $('.unPages').transition({ x:-(width * 0.6 / 5)});
      $('.unPages').attr("data-id", 1)
    } else {
      //console.log("hide")
      $('.unPages').transition({ x: (width * 0.6 / 5)});
      //$('.unPages').hide();
      $('.unPages').attr("data-id", 0)
    }
  })//click

  $(document).click(function(e){
    if ( !$(e.target).is('#page_alert, #page_alert_num, .unPages, .pageCntBox, .unPage, .pageli-2, img, .page_url_div, .page_url, .pageBoxTime, .pageBoxContent') ) {
      if (flag == 0) {
        $('.unPages').css({
          right:-250
        })
        flag=1;
        //alert(1)
        //console.log("hide")
        $('.unPages').transition({ x: 1});
        //$('.unPages').hide();
        $('.unPages').attr("data-id", 0)
        $('#page_alert').fadeIn(300);
        //$('.pageCntBox .pageBoxContent').empty();
      }
    }
  });

  $(document).on("click",".pageli-2",function() {
      popup = window.open($(this).data("url"),'_blank');
      //.window.focus();
  })
  $(document).on("click", "#unpages_open_all_btn", function(e) {
    $(".unPage").children().each(function(idx, item) {
      window.open($(item).attr("data-url"), "_blank");
    })
  });
  $(document).on("click", ".closeImg", function() {
    inputData=inputData = {"id":$(this).data("id")} 
    //alert(inputData)
    $.ajax({
      type: "POST",
      url: "/api/post/deleteunclassifiedpages",
      contentType: "application/x-www-form-urlencoded; charset=UTF-8",
      cache: false,
      data: inputData
    }).complete(function(){
        $.getJSON("/api/user/" + userID + "/unclassifiedpages", function(response) {
          $('.unPage').empty();
          //$('.unPage').append('<img id="loadingImg" src="/assets/loading2.gif" />');

          for (var i = 0; i < response.length; i++) {
            //한번만 박스 그려주도록
            if ($('.pageli-2').eq(i).hasClass('pageli2_' + i)) break;

            else {
              $('<li class="pageli-2 pageli2_' + i + '"></li>').appendTo('.unPage');
              $('.pageli2_'+i).append('<img id="loadingImg" class="img'+i+'" src="/assets/loading3.svg" />');
              $('<img id="closeImg'+i+'" class="closeImg" src="/assets/closeMini.png" onmouseover="closeHover(this);"" onmouseout="closeUnhover(this);" height="15px" width="15px"/>').appendTo('.unPage');
            }
          } //for

          $.each(response, function(i, page) {
            //$('.pageli-2').eq(i).append('<img class="img'+i+'" src="/assets/loading.gif" />');
            //$('.img'+i).after('<img class="img" src="http://ryugarden.org/api/thumb?url=' + page.url + '" />').hide().load(function(){});
            var img=$('<img class="img" src="http://ryugarden.org/api/thumb?url=' + page.url + '" />')
            img.load(function(){
              $('.img'+i).replaceWith(img);
            });
            $('#closeImg'+i).attr("data-id", page.id)
            //$('.pageli-2').eq(i).append('<img class="img" src="/' + page.url + '" />');
            $('.pageli-2').eq(i).append('<div class="page_url_div"><a class="page_url">' + page.title + '</a></div>');
            $('.pageli-2').eq(i).attr("data-url", page.url)
          })
          //$('.pageli-2 ').hide();
        }, 0).complete(function(){
          //alert(1)
          //$('#loadingImg').hide();
          //$('.pageli-2 ').show();
        })
      //////////////////////////////////////////////////////////////
    })
  });
  
  //드롭 했을 때 페이지 사이드바 다시 보이게 
  $('html').droppable({
    accept: '.pageCntBox, .pageli-2',
    drop: function(event, ui) {
      flag=1;
      $('#page_alert').trigger('click');
    }
  });
}

$(document).ready(function(){
	var width =window.screen.availWidth||window.innerWidth||document.body.clientWidth;
  var height =window.screen.availHeight||document.body.clientHeigh;
  var widthPosition =window.innerWidth||window.innerWidth||document.body.clientWidth;
  var heightPosition =window.innerHeight||document.body.clientHeigh;
  if(height<500){
	   width=1366;
	   height=768;
  }//if
  var alertNumGap; //페이지 담긴 수 변화 
  //사이즈 세팅
  setSize();
  //branch에 포함되지 않은 페이지들의 개수를 체크해 할당
  refreshIntervalId=setInterval( function(){
    //저장된 페이지의 수에 변화를 체크 
    checkPageAlerNum();    
    //console.log(alertNumGap)
    //저장된 페이지의 수에 변화가 생길때만 함수를 호출
    //if(alertNumGap!=0) showPageCntBox(1);
  }, 1000 );
  
  //pagesInform();
  
  showPages();
});


$(window).resize(function(){
	width =window.screen.availWidth||window.innerWidth||document.body.clientWidth;
	height =window.screen.availHeight||document.body.clientHeigh;
 	widthPosition =window.innerWㄴidth||window.innerWidth||document.body.clientWidth;
 	heightPosition =window.innerHeight||document.body.clientHeigh;
 	if(height<500){
    width=1366;
    height=768;
 	}//if

  //사이즈 세팅
  setSize();
  $('#page_alert').show();
  checkPageAlerNum();
  showPages();
});
</script>
